# Azure Pipelines CI/CD for Engine-Webflow Sync
# Triggers on push to main and develop branches
# Builds Node.js 18 function app and deploys to Azure Functions

trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Update these values after creating your Azure resources
  azureSubscription: 'YOUR_AZURE_SERVICE_CONNECTION'  # Name of your service connection in Azure DevOps
  functionAppName: 'engine-webflow-sync'  # Your Azure Function App name
  workingDirectory: '$(System.DefaultWorkingDirectory)'

stages:
  - stage: Build
    displayName: 'Build stage'
    jobs:
      - job: Build
        displayName: 'Build Function App'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
            displayName: 'Install Node.js 18.x'

          - script: |
              npm install
            workingDirectory: $(workingDirectory)
            displayName: 'npm install'

          - script: |
              # Optional: Run tests if you have them
              # npm test
              echo "Build validation complete"
            workingDirectory: $(workingDirectory)
            displayName: 'Run validation'

          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: '$(workingDirectory)'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
              replaceExistingArchive: true
            displayName: 'Archive files'

          - publish: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
            artifact: drop
            displayName: 'Publish artifact'

  - stage: Deploy
    displayName: 'Deploy stage'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: Deploy
        displayName: 'Deploy to Azure Functions'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureFunctionApp@2
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appType: 'functionAppLinux'
                    appName: '$(functionAppName)'
                    package: '$(Pipeline.Workspace)/drop/$(Build.BuildId).zip'
                    runtimeStack: 'NODE|18'
                    deploymentMethod: 'auto'
                  displayName: 'Deploy to Azure Functions'
